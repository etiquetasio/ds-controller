<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controller</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  height: 100vh;
  margin: 0;
  padding: 20px;
}
h2 { margin-bottom: 20px; }
button {
  margin: 5px;
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: limegreen;
  color: black;
}
button:hover { background: #32cd32; }
#url-form {
  display:flex;
  gap:10px;
  margin-top:20px;
  width:100%;
  max-width:500px;
}
#url-input {
  flex:1;
  padding:10px;
  border-radius:6px;
  border:none;
  font-size:14px;
}
#send-url {
  background: dodgerblue;
  color: white;
}
#send-url:hover { background: #1e90ff; }
#log {
  margin-top:20px;
  width:100%;
  max-width:600px;
  background:#222;
  padding:10px;
  border-radius:6px;
  height:150px;
  overflow-y:auto;
  font-size:13px;
}
#history {
  margin-top:15px;
  width:100%;
  max-width:600px;
  background:#1b1b1b;
  padding:10px;
  border-radius:6px;
}
#history h3 { margin:0 0 10px 0; font-size:14px; }
#history button {
  background:#444;
  color:#fff;
  margin:3px;
  font-size:13px;
  padding:6px 12px;
}
#history button:hover { background:#666; }
</style>
</head>
<body>
<h2>Controller</h2>
<div id="buttons">
  <button onclick="send('qrcode','0')">QRCODE HIDE</button>
  <button onclick="send('qrcode','1')">QRCODE SHOW</button>
  <button onclick="send('container','0')">ROTATE 0</button>
  <button onclick="send('container','90')">ROTATE 90</button>
  <button onclick="send('container','180')">ROTATE 180</button>
  <button onclick="send('container','270')">ROTATE 270</button>
  <button onclick="send('link','1')">LINK</button>
  <button onclick="send('link','0')">UNLINK</button>
</div>

<!-- Campo para enviar URL -->
<form id="url-form" onsubmit="publishURL(event)">
  <input type="text" id="url-input" placeholder="Digite a URL para exibir no player..." />
  <button type="submit" id="send-url">Enviar URL</button>
</form>

<!-- Hist√≥rico -->
<div id="history">
  <h3>Hist√≥rico de URLs</h3>
  <div id="history-list"></div>
</div>

<!-- Log do MQTT -->
<div id="log"></div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const duid = urlParams.get("duid") || "teste-duid";
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
const logDiv = document.getElementById("log");
const historyList = document.getElementById("history-list");
let urlHistory = [];

function log(msg){
  const p = document.createElement("div");
  p.textContent = msg;
  logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;
}

client.on("connect", () => {
  log("‚úÖ Controller conectado ao MQTT com DUID: " + duid);
});

function send(topic, value){
  const fullTopic = `${duid}/${topic}`;
  client.publish(fullTopic, value);
  log(`üì§ Enviado -> ${fullTopic}: ${value}`);
}

function publishURL(event){
  event.preventDefault();
  const url = document.getElementById("url-input").value.trim();
  if(url){
    send("url", url);
    addToHistory(url);
    document.getElementById("url-input").value = "";
  }
}

function addToHistory(url){
  if(!urlHistory.includes(url)){
    urlHistory.unshift(url);
    if(urlHistory.length > 5) urlHistory.pop(); // mant√©m s√≥ 5 √∫ltimas
    renderHistory();
  }
}

function renderHistory(){
  historyList.innerHTML = "";
  urlHistory.forEach(u => {
    const btn = document.createElement("button");
    btn.textContent = u;
    btn.onclick = () => send("url", u);
    historyList.appendChild(btn);
  });
}
</script>
</body>
</html>
