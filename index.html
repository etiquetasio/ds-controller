<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Digital Signage Rotativo</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
html, body {
  margin:0; padding:0; width:100%; height:100%;
  background:black; color:white; font-family:Arial,sans-serif; overflow:hidden;
}

#container {
  width:100%; height:100%; position:relative;
  overflow:hidden;
}

#start-btn {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  padding:30px 50px; font-size:24px; cursor:pointer;
  border:none; background:limegreen; color:black;
  border-radius:10px; z-index:2000;
}

#app-content { display:none; width:100%; height:100%; position:relative; z-index:100; }

#qr-container {
  position:absolute; bottom:2%; left:2%;
  display:flex; flex-direction:column; align-items:center; z-index:1000;
}
#logo-img { width:100px; height:100px; margin-bottom:5px; border-radius:8px; }
#qrcode { width:100px; height:100px; background:white; padding:5px; border-radius:8px; cursor:pointer; }
#duid-text { width:100px; font-size:12px; color:white; text-align:center; margin-top:2px; }

#status-container {
  position:absolute; bottom:2%; right:2%;
  display:flex; align-items:center; gap:5px; z-index:1000;
}
#status { width:10px; height:10px; border-radius:50%; background:red; }
#link-icon { width:16px; height:16px; display:none; fill:white; }

#linked-text {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:4vw; color:lime;
  opacity:0; transition:opacity 0.5s;
  pointer-events:none; text-align:center; z-index:9999;
}

/* Vídeo, Imagem e Iframe fullscreen */
#video-panel, #image-panel, #bg-iframe {
  position:absolute; top:0; left:0;
  width:100vw; height:100vh;
  z-index:0;
  background:black;
  display:none;
}
#video-panel video, #image-panel img, #bg-iframe {
  width:100%; height:100%;
  object-fit:cover;
  position:absolute;
  top:0; left:0;
}

/* Portrait → aplica rotação 270° */
#image-panel.portrait img {
  transform: rotate(270deg);
  transform-origin: center center;
}

/* Log canto superior esquerdo */
#log {
  position:absolute; top:2%; left:2%;
  width:25%; max-width:400px; max-height:25%;
  overflow-y:auto; color:#0f0; font-size:12px;
  background:rgba(0,0,0,0.5); padding:5px;
  border-radius:5px; z-index:2000;
}
</style>
</head>
<body>
<div id="container">
  <button id="start-btn">READY TO DIGITAL SIGNAGE</button>
  <div id="app-content">
    <div id="log">Aguardando mensagens...</div>
    <div id="video-panel"><video id="video-player" controls></video></div>
    <div id="image-panel"><img id="image-display"/></div>
    <iframe id="bg-iframe"></iframe>

    <div id="qr-container">
      <img id="logo-img" src="https://i.imgur.com/Uz1mlRP.png"/>
      <div id="qrcode"></div>
      <div id="duid-text"></div>
    </div>

    <div id="status-container">
      <div id="status"></div>
      <svg id="link-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
        <path d="M3.9,12a5,5,0,0,1,5-5h3v2H8.9a3,3,0,0,0,0,6h3v2h-3A5,5,0,0,1,3.9,12Zm8-3h4.2a3,3,0,0,1,0,6H11v-2h4.2a1,1,0,0,0,0-2H11Zm-1,5V10h2v4H10Z"/>
      </svg>
    </div>

    <div id="linked-text"></div>
  </div>
</div>

<script>
let duid = localStorage.getItem("duid");
if(!duid){ duid = "duid-" + btoa(navigator.userAgent + Date.now()).substr(0,12); localStorage.setItem("duid", duid); }

const startBtn = document.getElementById("start-btn");
const appContent = document.getElementById("app-content");
const qrDiv = document.getElementById("qrcode");
const duidText = document.getElementById("duid-text");
const statusDot = document.getElementById("status");
const linkIcon = document.getElementById("link-icon");
const linkedText = document.getElementById("linked-text");
const videoPanel = document.getElementById("video-panel");
const videoPlayer = document.getElementById("video-player");
const imagePanel = document.getElementById("image-panel");
const imageDisplay = document.getElementById("image-display");
const bgIframe = document.getElementById("bg-iframe");
const logEl = document.getElementById("log");
duidText.textContent = duid;

// QR Code
function generateQRCode(){
  const url = `https://etiquetasio.github.io/serverless-ds/controller.html?duid=${duid}`;
  const link = document.createElement("a"); link.href = url; link.target="_blank";
  const canvas = document.createElement("canvas");
  QRCode.toCanvas(canvas,url,{width:100,margin:1,color:{dark:"#000",light:"#fff"}},err=>{
    if(err)console.error(err);
    qrDiv.innerHTML=""; link.appendChild(canvas); qrDiv.appendChild(link);
  });
}
generateQRCode();

// MQTT
function initMQTT(){
  const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
  let linkedState = localStorage.getItem(`${duid}-linked`)==="true";
  let qrState = localStorage.getItem(`${duid}-qrcode`)!=="0";

  if(linkedState) linkIcon.style.display="inline-block";
  qrDiv.parentElement.style.display = qrState ? "flex" : "none";
  logEl.style.display = qrState ? "block" : "none";

  client.on("connect",()=>{ statusDot.style.backgroundColor="green"; client.subscribe(`${duid}/#`); logEl.textContent="[MQTT conectado]\n"+logEl.textContent; });
  client.on("close",()=>{ statusDot.style.backgroundColor="red"; logEl.textContent="[MQTT desconectado]\n"+logEl.textContent; });
  client.on("error",(err)=>{ statusDot.style.backgroundColor="red"; logEl.textContent=`[Erro MQTT: ${err}]\n`+logEl.textContent; });

  client.on("message",(topic,message)=>{
    const msg = message.toString();
    logEl.textContent=`[${topic}] ${msg}\n`+logEl.textContent;

    // IMAGE FULLSCREEN
    if(topic===`${duid}/url` && msg.match(/\.(jpeg|jpg|png|gif|webp)$/i)){
      const img = new Image();
      img.onload=()=>{
        imagePanel.classList.toggle("portrait", img.width<img.height);
        imageDisplay.src=msg;
        imagePanel.style.display="block";
        videoPanel.style.display="none";
        bgIframe.style.display="none";
      };
      img.src = msg;
      return;
    }

    // IFRAME fallback
    if(topic===`${duid}/url` && !msg.match(/\.(jpeg|jpg|png|gif|webp)$/i)){
      bgIframe.src=msg; bgIframe.style.display="block";
      videoPanel.style.display="none"; imagePanel.style.display="none";
      return;
    }

    // VIDEO
    if(topic===`${duid}/video`){
      videoPlayer.src=msg; videoPanel.style.display="block";
      imagePanel.style.display="none"; bgIframe.style.display="none";
      return;
    }

    // QR CODE toggle
    if(topic===`${duid}/qrcode`){
      if(msg==="0"){ qrDiv.parentElement.style.display="none"; logEl.style.display="none"; localStorage.setItem(`${duid}-qrcode`,"0"); }
      else { qrDiv.parentElement.style.display="flex"; logEl.style.display="block"; localStorage.setItem(`${duid}-qrcode`,"1"); }
    }

    // LINK toggle
    if(topic===`${duid}/link`){
      if(msg==="1"){ linkedText.textContent="LINKED SUCCESSFULLY"; linkedState=true; localStorage.setItem(`${duid}-linked`,"true"); linkIcon.style.display="inline-block"; }
      else { linkedText.textContent="UNLINKED"; linkedState=false; localStorage.setItem(`${duid}-linked`,"false"); linkIcon.style.display="none"; }
      linkedText.style.opacity="1"; linkedText.style.display="block";
      setTimeout(()=>{ linkedText.style.opacity="0"; setTimeout(()=>linkedText.style.display="none",500); },2000);
    }

    // FULLSCREEN
    if(topic===`${duid}/fullscreen`){
      if(msg==="1" && !document.fullscreenElement) document.documentElement.requestFullscreen();
      else if(msg==="0" && document.fullscreenElement) document.exitFullscreen();
    }
  });
}

// Start button
function startApp(){ startBtn.style.display="none"; appContent.style.display="block"; initMQTT(); }
startBtn.addEventListener("click", async ()=>{
  await document.documentElement.requestFullscreen();
  startApp();
});
</script>
</body>
</html>
